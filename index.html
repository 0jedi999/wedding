<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ร่วมแสดงความยินดี</title>
  <style>
    :root{--maxw:420px}
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Arial, sans-serif;
      max-width: var(--maxw);
      margin: 16px auto;
      padding: 18px;
      color: #111;
      background: #fff;
      -webkit-font-smoothing:antialiased;
    }
    .logo {text-align:center;font-size:20px;font-weight:700}
    .date {text-align:center;margin-bottom:18px;color:#444}

    .section {margin-bottom:14px}
    label{display:block;margin-bottom:6px;font-size:14px}

    input, textarea, button, .qr-box {
      width:100%;
      box-sizing:border-box;
      font-size:15px;
    }

    input, textarea {padding:10px;border:1px solid #ddd;border-radius:8px}
    textarea{min-height:90px;resize:vertical}

    button {padding:10px 12px;border-radius:8px;border:none;background:#111;color:#fff;cursor:pointer}
    button:disabled{background:#999}

    .qr-row{display:flex;gap:12px;align-items:center}
    .qr-box{width:120px;height:100px;background:#f2f2f2;border-radius:8px;display:flex;align-items:center;justify-content:center}

    .radio-option{display:flex;align-items:center;margin-top:6px}
    .radio-option input{margin-right:8px}

    /* modal */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:999;display:flex;align-items:center;justify-content:center}
    .modal-content{background:#fff;padding:20px;border-radius:12px;width:88%;max-width:420px;text-align:center}

    /* loading overlay - ensure default is hidden */
    #loadingOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:9998;align-items:center;justify-content:center}
    #loadingOverlay .box{background:#fff;padding:16px 20px;border-radius:10px;font-size:15px}

    @media (max-width:420px){body{margin:8px}}
  </style>
</head>
<body>

  <div class="logo">LOGO งานแต่ง</div>
  <div class="date">17 กุมภาพันธ์ 2026</div>

  <div class="section qr-row">
    <div class="qr-box" aria-hidden="true">Mini QR</div>
    <button id="uploadBtn" type="button">แนบสลิป</button>
  </div>

  <div class="section">
    <label for="amount">จำนวนเงิน</label>
    <input id="amount" type="number" min="0" inputmode="decimal" placeholder="เช่น 1000">
  </div>

  <div class="section">
    <label for="name">ชื่อ</label>
    <input id="name" type="text" placeholder="ชื่อ-นามสกุล">
  </div>

  <div class="section">
    <label>ฝ่าย</label>
    <label class="radio-option"><input type="radio" name="side" value="ฝ่ายเจ้าบ่าว">เจ้าบ่าว</label>
    <label class="radio-option"><input type="radio" name="side" value="ฝ่ายเจ้าสาว">เจ้าสาว</label>
  </div>

  <div class="section">
    <label>สะดวกเดินทางมาร่วมงานหรือไม่?</label>
    <label class="radio-option"><input type="radio" name="attendance" value="สะดวก">สะดวก</label>
    <label class="radio-option"><input type="radio" name="attendance" value="ไม่สะดวก">ไม่สะดวก</label>
  </div>

  <div class="section">
    <label for="message">คำอวยพร</label>
    <textarea id="message" placeholder="คำอวยพรของคุณ"></textarea>
  </div>

  <div class="section">
    <button id="submitBtn" type="button">ส่ง</button>
  </div>

  <!-- THANK YOU MODAL -->
  <div id="thankModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div id="thankText" style="text-align:left"></div>
      <div style="margin-top:12px"><button id="closeModalBtn" type="button">ปิด</button></div>
    </div>
  </div>

  <!-- loading overlay -->
  <div id="loadingOverlay">
    <div class="box">กำลังบันทึกข้อมูล กรุณารอสักครู่...</div>
  </div>

  <script>
    // ปรับเป็น URL ของ Google Web App ของคุณ
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxb9NjLkvW23fuz5KglXMUjTSzUJi1vFpUVmrDGj1Me8LgCRoSnKWBlLZ4yxb_9J9vT/exec";

    let isSubmitting = false;

    // ปุ่มแนบสลิป (ไปหน้า upload หรือเปลี่ยนให้เป็น modal อัปโหลดเองได้)
    document.getElementById('uploadBtn').addEventListener('click', () => {
      // หากคุณมีหน้าขึ้นสำหรับอัปโหลด ให้ใช้ goToUpload();
      window.location.href = 'upload.html';
    });

    // โหลดสถานะสลิปจาก sessionStorage
    window.addEventListener('load', () => {
      const slipData = sessionStorage.getItem('slipData');
      const btn = document.getElementById('uploadBtn');
      if (slipData) {
        btn.textContent = 'แนบสลิปแล้ว ✓';
        btn.style.background = 'green';
      } else {
        btn.textContent = 'แนบสลิป';
        btn.style.background = '';
      }
    });

    // บีบอัดรูป base64 -> return dataURL
    function compressImage(base64, maxWidth = 1200, quality = 0.7) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
          try {
            const canvas = document.createElement('canvas');
            const scale = Math.min(maxWidth / img.width, 1);
            canvas.width = Math.round(img.width * scale);
            canvas.height = Math.round(img.height * scale);
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            resolve(canvas.toDataURL('image/jpeg', quality));
          } catch (e) { reject(e); }
        };
        img.onerror = () => reject(new Error('Cannot load image'));
        img.src = base64;
      });
    }

    function setLoading(on) {
      const overlay = document.getElementById('loadingOverlay');
      overlay.style.display = on ? 'flex' : 'none';
      document.getElementById('submitBtn').disabled = on;
    }

    // ป้องกัน XSS ในข้อความก่อนใส่ innerHTML
    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/[&<>"'`=\/]/g, function (s) {
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'})[s];
      });
    }

    async function submitForm() {
      if (isSubmitting) return;
      isSubmitting = true;
      setLoading(true);

      const name = document.getElementById('name').value.trim();
      const amount = document.getElementById('amount').value.trim();
      const message = document.getElementById('message').value.trim();
      const sideEl = document.querySelector('input[name="side"]:checked');
      const attendanceEl = document.querySelector('input[name="attendance"]:checked');
      let slipData = sessionStorage.getItem('slipData');

      if (!name || !amount || !sideEl || !attendanceEl) {
        alert('กรอกข้อมูลให้ครบก่อนส่ง');
        isSubmitting = false;
        setLoading(false);
        return;
      }

      if (!slipData) {
        alert('กรุณาแนบสลิปก่อนส่ง');
        isSubmitting = false;
        setLoading(false);
        return;
      }

      try {
        // บีบอัดรูปก่อนส่ง (ถ้าเป็น dataURL อยู่แล้ว)
        slipData = await compressImage(slipData, 1200, 0.75);

        const payload = {
          name,
          amount,
          message,
          side: sideEl.value,
          attendance: attendanceEl.value,
          slipBase64: slipData
        };

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 15000);

        const resp = await fetch(WEBAPP_URL, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload),
          signal: controller.signal
        });
        clearTimeout(timeoutId);

        if (!resp.ok) throw new Error('Server returned ' + resp.status);

        const result = await resp.json();
        if (result && result.result === 'success') {
          showThankYou(name, sideEl.value, message);
          resetForm();
        } else {
          alert('บันทึกข้อมูลไม่สำเร็จ');
        }

      } catch (err) {
        if (err && err.name === 'AbortError') {
          alert('การเชื่อมต่อใช้เวลานานเกินไป กรุณาลองใหม่');
        } else {
          console.error(err);
          alert('ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้');
        }
      }

      isSubmitting = false;
      setLoading(false);
    }

    function showThankYou(name, side, message) {
      const el = document.getElementById('thankText');
      const safeName = escapeHtml(name);
      const safeMsg = escapeHtml(message) || '-';
      const html = `
        <strong>ขอขอบพระคุณ คุณ ${safeName}</strong><br>
        ${escapeHtml(side)}<br><br>
        ขอบคุณสำหรับคำอวยพร<br>
        "${safeMsg}"
      `;
      el.innerHTML = html;
      const modal = document.getElementById('thankModal');
      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden', 'false');
    }

    function closeModal() {
      const modal = document.getElementById('thankModal');
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden', 'true');
    }

    function resetForm() {
      document.getElementById('name').value = '';
      document.getElementById('amount').value = '';
      document.getElementById('message').value = '';
      document.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);
      sessionStorage.removeItem('slipData');
      const btn = document.getElementById('uploadBtn');
      btn.textContent = 'แนบสลิป';
      btn.style.background = '';
    }

    // bind events
    document.getElementById('submitBtn').addEventListener('click', submitForm);
    document.getElementById('closeModalBtn').addEventListener('click', closeModal);

  </script>
</body>
</html>
